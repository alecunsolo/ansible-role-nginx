---
- name: Get installed version.
  ansible.builtin.command:
    cmd: nginx -v
  changed_when: false
  register: ng_ver_cmd

- name: Store nginx version.
  ansible.builtin.set_fact:
    ng_ver: "{{ ng_ver_cmd.stderr | regex_search('nginx/([^ ]+)', '\\1') | first }}"

- name: Check if 'ssl_reject_handshake' directive is supported.
  ansible.builtin.set_fact:
    ng_ssl_reject_handshake_supported: "{{ ng_ver is version(nginx_ssl_reject_handshake_ver, '>=') }}"

# https://www.codedodle.com/disable-direct-ip-access-nginx.html
- name: Generate self sign certificate
  when: not ng_ssl_reject_handshake_supported
  block:
    - name: Ensure nginx cert dir exists.
      ansible.builtin.file:
        dest: /etc/nginx/ssl
        state: directory
        owner: root
        group: root
        mode: 0755
    - name: Ensure private key is present.
      community.crypto.openssl_privatekey:
        path: /etc/nginx/ssl/reject.key
        size: 2048
        owner: root
        group: root
        mode: 0600
        type: RSA
    - name: Ensure self-signed cert is present.
      community.crypto.x509_certificate:
        path: /etc/nginx/ssl/reject.crt
        privatekey_path: /etc/nginx/ssl/reject.key
        provider: selfsigned
        selfsigned_not_after: +3650d  # this is the default
        owner: root
        group: root
        mode: 0644

- name: Add common configuration files
  ansible.builtin.include_tasks: unsafe-conf.yml
  when: nginx_configure_default_block
  loop:
    - src: '{{ nginx_default_reject_site | default("default-reject.conf.j2") }}'
      dest: conf.d/default-reject.conf
